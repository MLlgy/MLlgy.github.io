---
title: Java 引用
tags: [Java,《深入理解 Java 虚拟机》读书笔记]
---


### 什么是引用


在 JDK1.2 以前对引用的定义为：
    如果 reference 类型的数据中存储的数值代表另外一块内存的起始地址，那么就称这块内存代表一个引用。

此定义将一个对象分为被引用或者没有被引用的两种状态，但是如果内存不足时被引用的对象由于不能被释放，自然就会导致 OOM。

所以我们需要定义一类这样的对象：当内存空间足够时，我们希望对象继续保存在内存中，如果内存不够时，我们可以回收这些对象。

所以在 JDK1.2 之后就对 Java 引用的概念进行了扩充，将引用细分为
  * 强引用(Strong Reference)
  * 软引用(Soft Reference)
  * 弱引用(Weak Reference)
  * 虚引用(Phantom Reference)


### 不同引用类型的回收机制

1. 强引用

    永远不会被回收，即使系统 OOM 也不会被回收，就是这么刚。

    d对于一个普通的而对象，如果没有其他引用关系，只要超过了引用的作用域或者显式的将相应的引用赋值为 null，就可以被 GC 回收了。

2. 软引用

    用来描述一些还有用并非必需的对象，**对于软引用的关联的对象，在系统将要发生 OOM 之前，将会把这些对象列入回收范围内，进行第二次回收**，如果此时内存还是不够，才会报出 OOM。

    软引用通常用来实现内存敏感的内存，如果还有空闲内存，就可以暂时保留缓存。当内存不足时才会清理掉，这样就保证了使用缓存的同事，不会耗尽内存。


3. 弱引用(WeakReference)

    弱引用也用了描述非必需的对象，但是它的强度比弱引用更弱一些，**被软引用关联的对象只能生存到下一次垃圾收集发生之前**。当垃圾收集器工作时，无论当前的内存是否够用，都会回收掉只被弱引用关联的对象。

    弱引用仅仅是提供一种访问在弱引用状态下对象的途径，这样就可以构建一种没有特定约束的关系，比如维护一种非强制的映射关系，如果试图获取时该对象还在，就是用它，否则就重新实例化。

    和软引用一样，弱引用也是很多缓存实现的选择。



4. 虚引用(PhantomReference)

    虚引用也称为幽灵引用或者幻影引用，它是最弱的一种引用关系。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用获取一个对象实例。

    为一个对象设置虚引用关联的唯一目的就是**能在这个对象被垃圾回收器回收时收到一个系统通知**。





### Reference

所有的引用类型，都是抽象类 java.lang.ref.Reference 的子类，它提供了 get() 方法，除了幻象引用(get() 获得的永远是 null)，如果对象还没有被销毁，都可以通过 get 方法获得原有的对象，这就意味着，可以利用软引用和弱引用将访问的对象重新指向强引用，所以引用类型之间是可以转换的。


但是如果我们将通过弱引用或软引用获得对象(get()方法)指向错误的强引用(比如说 static 变量)，那么这个对象就不可能再变回之前的弱引用或软引用的状态的了，就导致产生内存泄漏。所以检查弱引用指向的对象有没有被 GC，这是检查特定对象是否引起内存泄漏的思路。


### 引用队列(ReferenceQueue)的使用

> 在创建 Reference 类型时，将创建的 ReferenceQueue 注册到 Reference 中，当 Reference 所引用的对象被 GC 回收时，JVM
就会就该对象对应的 Reference 对象放到改该队列中，我们可以通过操作这个队列来完成一定的需求。

> 使用SoftReference，WeakReference，PhantomReference 的时候，可以关联一个ReferenceQueue。那么当垃圾回收器准备回收一个被引用包装的对象时，该引用会被加入到关联的ReferenceQueue。程序可以通过判断引用队列中是否已经加入引用,来了解被引用的对象是否被 GC 回收。
