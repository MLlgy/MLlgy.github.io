# 内存问题

## 内存引起的问题

1. 异常

内存不足，导致异常。

2. 卡顿

Java 内存不足，导致频繁的  GC，产生卡顿。

## 两个误区

1. 内存占用越少越好
2. Native 内存不用管

## 测量方法


1. Java 内存分配

Allocation Tracker(AS 工具)、MAT。

[Android内存申请分析](https://mp.weixin.qq.com/s/b_lFfL1mDrNVKj_VAcA2ZA?)

2. Native 内存分配

Malloc 调试和 Malloc 钩子。


# 内存优化


在开始内存优化前，首先应该评估2 **内存对于应用性能的影响**，可以通过崩溃中的 异常退出 和 OOM 的比例进行评估。

## 设定优化目标


## 内存优化探讨


### 设备分级

**内存优化首先需要根据设备环境来综合考虑**。

当然这需要有一个良好的架构设计支撑，在架构设计时需要做到以下几点。


1. 设备分级

对于低端机，可以关闭复杂动画，使用更小缓存的图片等。

2. 缓存管理
3. 进程模型

减少应用启动的进程数、减少常驻进程，有节操的保活。

4. 安装包大小

应用过大，很难在低端手机上运行，所以很多应用推出了 Lite 版。


### Bitmap 优化

Bitmap 内存一般占应用总内存很大一部分，所以做内存优化永远无法避开图片内存这个“永恒主题”。

如何优化图片内存，介绍两个方法：


1. 统一图片库

图片内存优化的前提是收拢图片的调用，这样我们可以做整体的控制策略。

2. 统一监控
  
* 大图监控；
* 重复图片监控；
* 图片总内存。


讲完设备分级和 Bitmap 优化，我们发现架构和监控需要两手抓，一个好的架构可以减少甚至避免我们犯错，而一个好的监控可以帮助我们及时发现问题。

### 内存泄漏

* Java 内存泄漏

建立类似 LeakCanary 自动检测机制。

* OOM 监控


## 内存监控


用户在前台的时候，可以每 5 分钟采集一次 PSS、Java 堆、图片总内存。我建议通过采样只统计部分用户，需要注意的是要按照用户抽样。