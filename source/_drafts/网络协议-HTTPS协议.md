---
title: '网络协议:HTTPS协议'
tags:
---



## HTTP 协议的风险


如果使用 HTTP 协议进行涉及金钱的请求，那么很有可能会黑客攻破。

**点外买场景：**

发送请求点外卖，但是这个网络包被黑客截获了，在服务器回复你之前，黑客假装自己是外卖网站，有可能回复你一个假的消息：请输入账号和密码，如果此时用户输入密码，无疑用户丢失个人敏感信息。


通过加密可以解决这个问题，加密方式存在对称加密和非对称加密。

* 对称加密

在对称加密中，加密和解密使用的是同一个密钥，如果想要保证安全的，就要保证密钥的安全。

* 非对称加密

在非对称加密中，加密的密钥和解密的密钥是不同的，一把是可以公开的公钥，一把是不可以公开的私钥。公钥加密的信息只有私钥才能够解开，私钥加密的信息只有公钥可以解开。


对称加密相较于非对称加密，效率高很多，性能好，在交互场景下使用对称加密。


## 对称加密的风险

用户和网站约定密钥，用户在发起网络请求时使用密钥进行加密，在网站使用密钥进行解密，即使黑客拦截到请求，因为没有密钥依旧如果破解请求中的信息。

但是用户和网站间的密钥如何传递，靠线下？一对一的时候还好，但是在客户增多，就显得不适合了。如果再对密钥进行加密传输，那么这个密钥又该如何传递，这样一层套一层，就会陷入死循环，这时可以引入非对称加密。


## 非对称加密的风险


非对称加密的私钥放在网站这里，不会进行公开传递，而对应的公钥可以在互联网上随意传播。用户在发起请求时使用公钥对信息进行加密，这样即使黑客拦截报文，因为没有私钥，所以无法解开，而网站因为拥有私钥，所以可以获取请求报文加密中的信息，进行处理，回复客户请求。

然而，网站在回复客户请求的时候，只能使用自己拥有的私钥进行加密，因为如果使用公钥加密，就只有拥有私钥的自己可以解密，显然这是不可以的。因为公钥可以在互联网上随意传播，所以私钥加密后的信息，在互联网上谁都可以解开。那么基于此，黑客可以使用公钥对网站发起攻击，黑客模拟向网站的请求，如果请求频率很高，很有可能网站会挂掉。


为了解决这个问题，需要客户端也要有自己的私有和公钥，将公钥暴露出来，那么此时的网络交互就变成这样：

1. 客户端在发起请求的时候，使用网站的公钥进行加密。
2. 网站接收到报文，使用网站的私钥进行解密。
3. 网站进行业务处理
4. 回复客户端请求时，将信息使用客户端的公钥进行加密
5. 客户端收到网站的回复，使用客户端的私钥进行解密，获取信息
6. 客户端进行业务操作

这样就保证了通信双方的安全，即使黑客拦截了网站回复信息，或者模拟客户端向网站发起请求，但是由于没有私钥，所以依旧无法获得信息。


但是即使这样处理后，非对称加密依旧和对称加密面临相同的问题：如果将公钥传给对方？

如果客户端获得的是黑客模拟网站的公钥，那么客户端所有的请求信息都会被黑客模拟的网站获取，那么用户的私人敏感信息也会被轻易获取。针对这个现象，引入了数字证书。


## 数字证书

**流程**

1. 搭建个人网站，创建私钥

```
openssl genrsa -out cliu8siteprivate.key 1024
```

cliu8siteprivate.key:私钥。

2. 根据私钥创建对应的公钥

```
openssl rsa -in cliu8siteprivate.key -pubout -outcliu8sitepublic.pem
```
生成的公钥：outcliu8sitepublic.pem。

3. 生成证书

类比生活中例子，我们每个人都可以打印自己的简历，但是需要公安部门盖章的只有户口本。这个有权威部门颁发的称为 **证书(Certificate)**。

证书的内容：

* 公钥(最重要的) 
* 证书的所有者(类比户口本上的姓名和身份证号)
* 发布机构和有效期(类比户口本上的哪所公安局、有效期时间)

**证书生成流程：**

生成一个证书需要发起一个请求，这个请求会发给一个权威机构去认证，这个权威机构称为 CA(Certificate Authority)。

* 证书生成请求：
```
openssl req -key cliu8siteprivate.key -new -out cliu8sitecertificate.req
```

cliu8sitecertificate.req：证书生成的请求。

* 将请求发送给权威机构，权威机构会对这个证书进行认证，称为 **签名算法**


签名算法的大致工作原理：

    对信息做一个 Hash 计算，得到一个 Hash 值，这个过程是 **不可逆** 的，无法根据 Hash 值获取原来的信息内容。发信息发送时，会把 Hash 值加密后和信息一块发布。


此时存在一个问题：如何签名才能保证是真的权威机构的签名呢? 同理在生活中也存在伪造身份证、户口的现象。

这个问题的答案就是：只有保证进行签名的东西，只掌握在权威机构手中，这个东西就是 **CA 的私钥**，那么此时就可以保证这个签名就是真的。


权威机构给证书签名的命令：

```
openssl x509 -req -in cliu8sitecertificate.req -CA cacertificate.pem -CAkey caprivate.key -out cliu8sitecertificate.pem
```
这个命令会返回 Signature ok，代表签名成功，cliu8sitecertificate.pem：签过名的证书。

**权威机构 CA 用自己的私钥对网站的公钥进行加密，那么就相当于为网站背书，形成了网站的证书。**


**查看证书内容：**

```
openssl x509 -in cliu8sitecertificate.pem -noout -text 
```

证书的主要内容：

* Issuer: 证书是谁颁发的。
* Subject：证书颁发给谁的。
* Validity:证书的期限。
* Public-key: 公钥的内容。
* Signature Algorithm: 签名算法。

**证书的使用**

有了证书，此时网站从服务端获得的不再是公钥了，而是得到一个证书(xx.pem)，这个证书的发布机构为 CA，只有获得了 CA 的公钥，就可以解密服务端证书的签名(签名使用 CA 私有加密，使用 CA 公钥可以解析)，如果成功解析，对信息进行一个 Hash 计算，如果计算后的 Hash 值和解密后的 Hash 值相同，那么就说明服务端的公钥没有问题。


**存在的问题：**

在非对称加密和对称加密过程中的存在的问题，在验证数字证书过程中依旧存在：如何保证 CA 的公钥是正确的？

如果你申请到的证书是由黑客生成的，并且获得的所谓 CA 公钥也是黑客提供的，那么同样也是可以解析请求的信息。

针对这种现象，CA 公钥需要更牛的 CA 给他签名，然后形成 CA 证书。要想知道某个 CA 证书是否可靠，要看上级证书的 CA 公钥，能否解开这个 CA 的签名。这样一层一层追溯，知道全球几个著名的 CA,称为 root CA，作背后的背书。

通过这种 **层层授信背书** 的方式，从而保证了非对称加密模式的正常运转。



各大 CA 机构的公钥默认是安装在操作系统中的，如果使用 


## HTTPS 的工作模式

非对称加密在性能上不如对称加密，如果将两者结合起来，这就是 SSL/TLS 协议的基本思路。只在证书验证阶段使用非对称加密，在内容传输时使用协商的密钥进行对称加密。











---

自己询问公司运维：

在服务器和公网之间配置 HTTPS 代理，将证书配置到 HTTPS 上，这样外网访问为 HTTPS，而 HTTPS 与 服务器之间使用 HTTP 连接。



---


[使用 HTTPS 自签名证书进行 API 请求](https://yq.aliyun.com/articles/655544)

[Android Https相关完全解析 当OkHttp遇到Https](https://blog.csdn.net/lmj623565791/article/details/48129405) 同样也是自签名过程

[HTTPS 原理分析——带着疑问层层深入](https://mp.weixin.qq.com/s/l7cftdHC_FO9VYiV5HBrDg)


使用 Charles 抓包 HTTPS步骤：

1. 在操作系统中安装 Chareles 的根证书，并信任。
2. 在手机端配置根证书。

![](/source/images/2019_12_10_01.png)

---

[Charles的HTTPS抓包方法及原理分析](https://www.jianshu.com/p/870451cb4eb0)

[Charles 抓包HTTPS原理](https://www.jianshu.com/p/f504848d62e0)


为了实现这个过程的数据获取，Charles需要做的事情是对客户端伪装服务端，对服务端伪装客户端，具体

* 截获真实客户端的HTTPS请求，伪装客户端向真实服务端发送HTTPS请求
* 接受真实服务器响应，用Charles自己的证书伪装服务端向真实客户端发送数据内容
