---
title: Android系统启动-Init进程概述
tags:
---

> 本文是对 Init 进程的概述，不会涉及具体代码，主要的目的是对 Init 进程在 Android 系统中的位置、具体承担工作等有一个感性的认识，而本文的完成是站在巨人的肩膀上，主要参考了相关书籍、比较权威的博客，具体来源会在文章中表明，从而完成自己对 Init 进程的初步理解，并且接下来自己也会对 Init 源码层面进行具体学习。



## init 进程概述

init 进程是 Linux 系统中用户空间的第一个进程，也是 Andorid 系统中用户空间的第一个进程，进程号为 1。

作为用户空间的第一个进程， init 进程被系统赋予了极其重要的责任，主要有：

1. init 进程负责创建系统中几个关键的进程，比如 Zygote 进程。
2. Android 系统中有许多的属性，所以 init 进程提供了一个属性服务(Property Service)来管理这些服务。

## init 进程的入口

`init.cpp#main`


## init 工作流程

1. 解析两个配置文件，包括 init.rc  init.xx.rc 。
2. 根据解析文件后的结果，执行各个阶段的动作，创建 Zygote 的工作就是在其中的一个阶段完成的。
3. 调用 `property_int` 初始化属性相关的资源，并通过 `property_start_service` 启动属性服务。
4. init 进程进入一个无限循环过程，等待一些事情的发生，处理来自 **socket** 和 **属性服务器** 相关的事情。
   

## 什么是属性服务


在 Windows 平台存在注册表这种东西，注册表可以存储一些类似 key/value 的键值对。系统或者某些应用程序会把自己的一些属性存储在注册表中，这样的话，即使系统重启或者应用程序重启，还是能够根据在之前的注册表设置的属性，进行初始化工作。


同样的 Android 系统也提供了一个类似的机制，称之为 **属性服务**，应用程序可以根据这个机制，**查询或者设置属性**，通过 `adb shell` 登录到手机上，可以通过 `getprop` 获得当前系统中存在哪些属性。



## 属性服务的实现


1. 属性服务的初始化


    1. 创建存储空间
    2. 客户端进程获取存储空间

2. 属性服务的分析

    init 进程会启动一个 **属性服务器**，而客户端只能通过与属性服务器交互来设置属性。

    1. 启动属性服务器：`start_property_service`
    2. 接收客户端的请求，处理设置属性请求

        当属性服务器收到客户端的请求时，init 会调用 `handle_property_set_fd` 进行处理，若客户端有足够的权限，则调用 `property_set` 进行处理。    
        
3. 客户端如何设置属性
    
    通过 `property_set` 发送请求，该函数由 `libcutils` 提供


通过源代码可知，客户端和属性服务器是通过 **socket** 进行发起请求和响应请求的。

以上内容参考自：[深入理解Android(卷1)](https://book.douban.com/subject/6802440/)

---

## init 进程的主要功能

init进程是Linux系统中 **用户空间的第一个进程**，进程号固定为1。Kernel启动后，在用户空间启动init进程，并调用init中的main()方法执行init进程的职责。对于init进程的功能分为4部分：

* 解析并运行所有的init.rc相关文件
* 根据rc文件，生成相应的设备驱动节点
* 处理子进程的终止(signal方式)
* 提供属性服务的功能

## init 简化工作流

init进程(pid=1)是Linux系统中 **用户空间的第一个进程**，主要工作如下：

* 解析 init.rc 文件，fork 自身生成 Zygote 进程;
* 创建一块共享的内存空间，用于 **属性服务器**;
* 解析各个rc文件，并启动相应属性服务进程;
* 初始化epoll，依次设置signal、property、keychord这3个fd可读时相对应的回调函数;
* 进入无限循环状态，执行如下流程：
    * 检查action_queue列表是否为空，若不为空则执行相应的action;
    * 检查是否需要重启的进程，若有则将其重新启动;
    * 进入epoll_wait等待状态，直到系统属性变化事件(property_set改变属性值)，或者收到子进程的信号SIGCHLD，再或者keychord 键盘输入事件，则会退出等待状态，执行相应的回调函数。
    

## init 进程启动后的核心工作

可见init进程在 **开机之后**_的核心工作就是 **响应property变化事件** 和 **回收僵尸进程**。

* **响应property变化事件**:当某个进程调用property_set来改变一个系统属性值时，系统会通过socket向init进程发送一个property变化的事件通知，那么property fd会变成可读，init进程采用epoll机制监听该fd则会 触发回调handle_property_set_fd()方法。
* **回收僵尸进程**:在Linux内核中，如父进程不等待子进程的结束直接退出，会导致子进程在结束后变成僵尸进程，占用系统资源。为此，init进程专门安装了SIGCHLD信号接收器，当某些子进程退出时发现其父进程已经退出，**则会向init进程发送SIGCHLD信号**，init进程调用回调方法handle_signal()来回收僵尸子进程。

以上内容参考自：[Android系统启动-Init篇](http://gityuan.com/2016/02/05/android-init/)

---