---
title: Java 内存空间类别
date: 2019-01-16 15:23:17
tags: [Java,内存分区]
---




## 1. 概述

Java 不像 C/C++ 需要程序员自己管理内存，Java 把内存控制的权利交给类 Java 虚拟机。


## 2. 运行时数据区域

JVM 在 Java 程序运行时把它所管理的内存划分为几个不同的数据区域。

![运行时内存区域](/images/2019_01_16.jpg)

<!-- (https://img-blog.csdnimg.cn/20190111154945144.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1N0cmFuZ2VfTW9ua2V5,size_16,color_FFFFFF,t_70) -->

### 2.1 程序计数器

程序计数器是一块较小的内存，它可以看作 **当前线程** 所执行的 **字节码的行号指示器**。**在虚拟机的概念模型里，字节码解释器的工作就是通过改变这个计数器的值** 来选取下一条需要执行的字节码，分支、循环、跳转、异常处理、线程恢复等基础功能都需要这个计数器来完成**。

如上图所示，程序计数器是线程私有的。

**如何执行工作**

如果线程正在执行一个 Java 方法，这个计数器记录的正是执行的虚拟机字节码指令的地址，如果执行的是 Native 方法，这个计数器值为空。

<!--more-->

### 2.2 Java 虚拟机栈

**Java 虚拟机栈是线程私有的，其生命周期与线程相同。**

虚拟机栈描述的是 Java 方法执行的内存模型： 每个 Java 方法执行的同时都会创建一个 **栈帧(stack frame)**,栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用到执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。

平时的把 Java 内存分为 堆内存(heap) 和 栈内存(stack) 的分类方法是比较粗糙的，实际分类方法十分复杂。这种分类方法中栈即为虚拟机栈，或为虚拟机中的局部变量表。


局部变量表存放了编译期可知的各种数据类型(boolean、byte、char、short、int、float、long、double)、对象引用(不等同于对象本身，可能是一个对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置)和returnAddress(指向一条字节码指令的地址)。

局部变量表所需的内存空间在编译期间分配完成，当进入一个方法时，这个方法需要在栈帧中分配多的的局部变量空间是完全确定的，在方法的运行期间不会改变局部变量表的大小。

### 2.3 本地方法栈

本地方方法栈与虚拟机栈发挥的作用相似，不同的是该栈为 Native 方法服务。

### 2.4 Java 堆


Java 堆对于大部分应用来说都是 JVM 所管理的内存中最大的一块。Java 堆是 **所有线程共享** 的一块内存区域,**在虚拟机启动时创建**。

Java 堆的唯一的目的就是存放对象实例，几乎所有的对象实例都在这里分配内存 -- **所有的对象实例以及数组都要在堆上分配**。

Java 堆的分配可以在物理上不连续的内存空间，只要逻辑上连续就可以，可以固定大小，也可以扩展空间。

Java 堆是 GC 发生的主要区域。

### 2.5 方法区

方法区与 Java 堆一样是所有线程共享的内存空间，**它用于储存已被虚拟机加载的类信息、常量、静态常量、即时编译器编译后的代码等数据**。Java 虚拟机把方法区描述为堆的一个逻辑部分，但是它还有一个别名 -- Non-Heap(非堆)，目的应该是与 Java 堆区分。

### 2.6 运行时常量池

运行区常量池是方法区的一部分。 Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是 **常量池** ，用于存放编译器生成的各种字面量和符号引用，这部分内容将在类加载后进入方法去的运行时常量池中存放。


```
字面量和符号引用-->常量池-->运行时常量池
```

### 2.7 直接内存

> 没有接触过相关概念。

直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域。但是这部分内存也被频繁地使用，而且也可能导致OutOfMemoryError异常出现，所以我们放到这里一起讲解。

### 2.8 小结

数据区域| 功能|线程相关|备注
----|---|---|:--:
程序计数器 | 字节码执行指示器| 线程私有|
Java 虚拟机栈 |为 Java方法服务、存放编译期基本数据类型以及对象引用|线程私有|平常被称为的 "栈"、空间较小
|本地方法栈|与 Java 虚拟机栈类似，为 Native 方法服务|线程私有||
|Java 堆|存放对象(对象实例以及数组)|线程共享|GC 主要区域、空间较大|
|方法区|存储类信息、常量、静态变量、即时编译器编译后等数据|线程共享||
|运行时常量池|常量池存放编译期生成的各种字面量和符号引用、常量池在类加载后存储在运行时常量池|线程共享|方法区的一部分、常量池会存储在其中|
|直接内存||||



---

**知识链接**

&nbsp;&nbsp;&nbsp;&nbsp;[深入理解Java虚拟机：JVM高级特性与最佳实践](http://product.dangdang.com/23259731.html)


**发现好的博文**

[这一次，彻底解决Java的值传递和引用传递](https://juejin.im/post/5bce68226fb9a05ce46a0476)