---
title: TCP 的三次握手和四次挥手
date: 2019-05-06 11:35:16
tags: [网络协议,TCP]
---


TCP 协议做的是：在算法层面保证可靠性。

有关可靠性的指标：
* 保证顺序
* 不丢包
* 维护 TCP 连接
* 流量控制
* 拥塞控制

为了能够保证以上指标，设计了对于的 TCP 包头格式,如下：


![TCP 包头格式](/../images/2019_05_06_01.jpg)


### TCP 三次握手

为了更好的理解 TCP 三次握手，来看一下生活中场景(A、B 两人彼此自我介绍的场景):

---

**1、A (A -> B):** 你好，我是 A(此时 A 不知道 B 是否收到自己的介绍，所以 A 现在等待 B 的 **应答**)。

**2、B (B -> A):** 你好，我是 B(此时 B 不知道 A 是否收到自己的介绍，所以 B 现在等待 A 对自己的应答进行应答，可称为 **应答之应答**)。

**3、A (A -> B):** 你好 B (此时 A 已经知道了 B，同时 B 也知道了 A , A 认为双方建立了连接，即使此次数据发送失败，当 A 开始发送数据时，也可完成连接)。

---

以上情况是在比较顺畅的情况两人建立了友谊关系，当然也会存在异常情况，如下几种：

#### 异常情况一

步骤一中 A 发送的数据包丢失，因为各种原因：丢失、绕路、B 没有响应等情况，无法进入到步骤二，由于 A 没有收到发送数据包的应答，所以 A 会再次发送数据包，如果还是无法收到应答，还会再发。

#### 异常情况二

A 发送的请求到达 B ,此时 B 已经知道了 A 的存在，如果 B 想要建立连接，就会发送应答给 A；如果 B 不想建立连接，就不会发送应答，A 在尝试发送数据包一段时间后就会放弃，此时建立连接失败。


#### 异常请求三

在 A 多次发送请求数据包时，各步骤终于顺畅的进行下去，A、B 建立连接。 在两者进行短暂的交流后结束了谈话后，此时结束了连接，但是此时 A 建立连接时发送的数据包经过一段时间的绕路后，来到了 B ，如果 B 认为这是一个正常的请求的话建立了连接，此时这个连接不会进行下去，但是也不会有结束的时候，极大的浪费了网络资源。这个异常情况在说明了 **两次握手是不可以的**。

#### 异常情况四

B 发送的应答可能会发送多次，但是只要有一次到达了 A ，那么 A 就会认为已经建立了连接，因为 **对于 A 来说消息有去有回**。当 A 为此次应答发送的应答到达 B 后，B 就认为已经建立了连接，因为 **对于 A 来说消息也是有去有回**。

但是此时也会出现异常情况，如果 A 发送的应答消息丢失。按理来说，针对每一个应答都会有对方的应答之应答，依次循环往复，那么多少次握手都是可以的，但是并不能保证连接都是可靠的，所以 **只要保证 A、B 双方的消息都有去有回就可以了**，这也是为什么 **TCP 建立连接需要三次握手的原因** 了。

如果 A 发送的应答丢失了，此